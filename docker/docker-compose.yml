version: "3.8"

services:
  pyrobud:
    build:
      context: ..
      dockerfile: docker/Dockerfile.debian
    image: ${DOCKER_IMAGE:-bluscream1/pyrobud}:${DOCKER_TAG:-latest}
    container_name: pyrobud
    restart: unless-stopped

    # Volume mappings for organized data structure
    volumes:
      # Config files and session files (.toml, .session)
      - ${CONFIG_DIR:-./data/cfg}:/data/cfg:rw
      # Database directories (.db/)
      - ${DB_DIR:-./data/db}:/data/db:rw
      # Custom modules directory (entrypoint.sh will symlink this to the installed location)
      - ${CUSTOM_MODULES_DIR:-./data/custom_modules}:/data/custom_modules:ro

      # Alternative: Single data directory (commented out)
      # - pyrobud-data:/data

    # Command override to use config from cfg directory
    # Default config path is /data/cfg/config.toml
    # You can override this with CONFIG_FILE environment variable
    # Command will use CONFIG_FILE env var from Dockerfile (defaults to config.toml)
    # Override by setting CONFIG_FILE environment variable below

    # Environment variables
    environment:
      # Timezone
      - TZ=${TZ:-UTC}
      # Python unbuffered output for better logging
      - PYTHONUNBUFFERED=1
      # Config file name (within /data/cfg/)
      - CONFIG_FILE=${CONFIG_FILE:-config.toml}
      # Optional: Enable file logging (auto-rotates at 10MB, keeps 5 backups)
      # Alternatively, use --log-file CLI arg or [logging] section in config
      # - PYROBUD_LOG_FILE=/data/cfg/pyrobud.log

    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Network mode (default bridge is usually fine)
    # network_mode: bridge

    # Health check (optional)
    healthcheck:
      test: ["CMD", "pgrep", "-f", "pyrobud"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
# Optional: Named volumes (uncomment if not using host paths)
# volumes:
#   pyrobud-config:
#     driver: local
#   pyrobud-db:
#     driver: local
#   pyrobud-modules:
#     driver: local
